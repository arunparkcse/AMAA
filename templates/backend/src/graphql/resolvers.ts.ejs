import { <%= toPascal(authEntity) %> } from '../models/<%= authEntity %>';
<% entities.forEach(ent => { %>
import { <%= toPascal(ent.name) %> } from '../models/<%= ent.name %>';
<% }) %>
import { GraphQLUpload } from 'graphql-upload';
import fs from 'fs';
import path from 'path';

const uploadDir = path.join(__dirname, '../../uploads');
if (!fs.existsSync(uploadDir)) fs.mkdirSync(uploadDir, { recursive: true });

export const resolvers = {
  Upload: GraphQLUpload,

  Query: {
    <% entities.forEach(ent => { %>
    <%= toCamel(ent.name) %>s: async () => await <%= toPascal(ent.name) %>.findAll(),
    <%= toCamel(ent.name) %>: async (_: any, { id }: { id: string }) => await <%= toPascal(ent.name) %>.findByPk(id),
    <% }) %>
  },

  Mutation: {
    <% entities.forEach(ent => { %>
    create<%= toPascal(ent.name) %>: async (_: any, { input, file }: any) => {
      const data = { ...input };
      if (file) {
        const { createReadStream, filename } = await file;
        const stream = createReadStream();
        const outPath = path.join(uploadDir, `${Date.now()}-${filename}`);
        await new Promise((res, rej) =>
          stream.pipe(fs.createWriteStream(outPath)).on('finish', res).on('error', rej)
        );
        data.image = `/uploads/${path.basename(outPath)}`;
      }
      return await <%= toPascal(ent.name) %>.create(data);
    },
    update<%= toPascal(ent.name) %>: async (_: any, { id, input, file }: any) => {
      const instance = await <%= toPascal(ent.name) %>.findByPk(id);
      if (!instance) throw new Error('Not found');
      const data = { ...input };
      if (file) {
        const { createReadStream, filename } = await file;
        const stream = createReadStream();
        const outPath = path.join(uploadDir, `${Date.now()}-${filename}`);
        await new Promise((res, rej) =>
          stream.pipe(fs.createWriteStream(outPath)).on('finish', res).on('error', rej)
        );
        data.image = `/uploads/${path.basename(outPath)}`;
      }
      await instance.update(data);
      return instance;
    },
    delete<%= toPascal(ent.name) %>: async (_: any, { id }: { id: string }) => {
      const instance = await <%= toPascal(ent.name) %>.findByPk(id);
      if (!instance) return false;
      await instance.destroy();
      return true;
    },
    <% }) %>
  }
};